<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Campus Dating Chat</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .badge {
      background: crimson;
      color: white;
      border-radius: 50%;
      padding: 2px 8px;
      font-size: 11px;
      margin-left: 8px;
      display: inline-block;
      min-width: 18px;
      text-align: center;
    }
    #typingIndicator { font-style: italic; color: #666; margin-bottom:5px; }
    .message p:hover { background:#f0f0f0; cursor:pointer; }
    .active { background:#e0e0ff; }
    .contact { padding:5px; border-bottom:1px solid #ddd; cursor:pointer; }
  </style>
</head>
<body>
  <h2>Campus Dating Chat</h2>

  <div id="typingIndicator"></div>
  <div id="contacts"></div>
  <div id="chatBox"></div>

  <input id="messageInput" placeholder="Type a message..."/>
  <button id="sendBtn">Send</button>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
  // ==============================
  // CONFIG
  // ==============================
  const API = "https://campus-dating-backend-10.onrender.com";
  const socket = io(API);

  // Replace with real logged-in user
  const currentUser = "alice";  
  let activeContact = null;
  let unreadCounts = {};
  let typingTimeout;

  const contactsDiv = document.getElementById("contacts");
  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("messageInput");
  const typingIndicatorDiv = document.getElementById("typingIndicator");
  const sendBtn = document.getElementById("sendBtn");

  // ==============================
  // SOCKET EVENTS
  // ==============================
  socket.emit("user-online", currentUser);

  socket.on("update-users", (users) => {
    loadContacts(users);
  });

  // Typing indicator
  socket.on("typing", ({ sender, receiver }) => {
    if(sender === activeContact && receiver === currentUser) {
      typingIndicatorDiv.textContent = `${sender} is typing...`;
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => { typingIndicatorDiv.textContent = ""; }, 2000);
    }
  });

  // Handle incoming messages
  socket.on("chat-message", (msg) => {
    if(msg.receiver === currentUser) {
      if (msg.sender === activeContact) {
        renderMessage(msg);
      } else {
        unreadCounts[msg.sender] = (unreadCounts[msg.sender] || 0) + 1;
        loadContacts();
      }
    }
  });

  // ==============================
  // EVENTS
  // ==============================
  messageInput.addEventListener("input", () => {
    if(activeContact) {
      socket.emit("typing", { sender: currentUser, receiver: activeContact });
    }
  });

  sendBtn.addEventListener("click", () => {
    if(activeContact && messageInput.value.trim()) {
      const msg = { sender: currentUser, receiver: activeContact, text: messageInput.value };
      socket.emit("chat-message", msg);
      renderMessage(msg);
      messageInput.value = "";
    }
  });

  // Delete message
  chatBox.addEventListener("click", async (e) => {
    const msgId = e.target.dataset.id;
    if(!msgId) return;
    if(confirm("Delete this message?")) {
      await fetch(`${API}/api/message/${msgId}/${currentUser}`, { method: "DELETE" });
      e.target.remove();
    }
  });

  // ==============================
  // FUNCTIONS
  // ==============================
  function loadContacts(userStatuses = {}) {
    fetch(`${API}/api/contacts/${currentUser}`)
      .then(res => res.json())
      .then(contacts => {
        contactsDiv.innerHTML = "";
        contacts.forEach(contact => {
          const div = document.createElement("div");
          div.className = "contact";
          div.innerHTML = `
            <span>${contact}</span>
            <small style="color:gray; margin-left:8px;">
              ${userStatuses[contact] || "offline"}
            </small>
          `;
          if(unreadCounts[contact]) {
            const badge = document.createElement("span");
            badge.className = "badge";
            badge.textContent = unreadCounts[contact];
            div.appendChild(badge);
          }
          div.onclick = () => {
            selectContact(contact, userStatuses);
            unreadCounts[contact] = 0;
            loadContacts(userStatuses);
          };
          if(contact === activeContact) div.classList.add("active");
          contactsDiv.appendChild(div);
        });
      });
  }

  function selectContact(contact, userStatuses={}) {
    activeContact = contact;
    chatBox.innerHTML = "";
    fetch(`${API}/api/messages/${currentUser}/${contact}`)
      .then(res => res.json())
      .then(messages => {
        chatBox.innerHTML = "";
        messages.forEach(msg => renderMessage(msg));
      });
  }

  function renderMessage(msg) {
    const p = document.createElement("p");
    p.dataset.id = msg._id || ""; 
    p.textContent = `${msg.sender}: ${msg.text}`;
    chatBox.appendChild(p);
  }

  // Initial load
  loadContacts();
  </script>
</body>
</html>
