<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Dating App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #004080; color: #fff; padding: 10px; text-align: center; }
    main { padding: 10px; }
    .hidden { display: none; }
    .chat-list, .messages { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; max-height: 300px; overflow-y: auto; background: #fff; }
    .message { margin-bottom: 5px; padding: 5px; border-radius: 5px; }
    .message.self { background: #DCF8C6; text-align: right; }
    .message.other { background: #fff; text-align: left; }
    .status-feed { border: 1px solid #ccc; padding: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto; background: #fff; }
    input, select, button { padding: 5px; margin: 5px 0; }
  </style>
</head>
<body>
  <header>
    <h1>Campus Dating</h1>
  </header>
  <main>
    <section id="auth-section">
      <h2>Register / Login</h2>
      <input type="text" id="countryCode" placeholder="Country code e.g +254">
      <input type="text" id="phone" placeholder="Phone number">
      <input type="password" id="password" placeholder="Password">
      <button id="registerBtn">Register</button>
      <button id="loginBtn">Login</button>
      <div id="auth-msg"></div>
    </section>

    <section id="app-section" class="hidden">
      <h2>Welcome, <span id="userPhone"></span></h2>
      <h3>Sync Contacts</h3>
      <textarea id="contactsInput" placeholder="Enter phone numbers separated by commas"></textarea>
      <button id="syncContactsBtn">Sync</button>
      <div id="contactsList" class="chat-list"></div>

      <h3>Chat</h3>
      <select id="chatWith"></select><br>
      <div id="messages" class="messages"></div>
      <input type="text" id="messageInput" placeholder="Type a message">
      <button id="sendBtn">Send</button>

      <h3>Status Feed</h3>
      <textarea id="statusInput" placeholder="Post a status"></textarea>
      <button id="postStatusBtn">Post Status</button>
      <div id="statusFeed" class="status-feed"></div>
    </section>
  </main>

  <script>
    const API = 'https://campus-dating-backend-25.onrender.com';
    let token = '';
    let currentUser = '';

    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const userPhoneSpan = document.getElementById('userPhone');
    const authMsg = document.getElementById('auth-msg');
    const contactsList = document.getElementById('contactsList');
    const chatWithSelect = document.getElementById('chatWith');
    const messagesDiv = document.getElementById('messages');
    const statusFeedDiv = document.getElementById('statusFeed');

    // --- Register ---
    document.getElementById('registerBtn').onclick = async () => {
      const phone = document.getElementById('phone').value.trim();
      const countryCode = document.getElementById('countryCode').value.trim();
      const password = document.getElementById('password').value.trim();
      if(!phone || !password) { authMsg.innerText='Enter phone & password'; return; }

      const res = await fetch(API+'/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: countryCode+phone, password })
      });
      const data = await res.json();
      authMsg.innerText = data.message || data.error;
    }

    // --- Login ---
    document.getElementById('loginBtn').onclick = async () => {
      const phone = document.getElementById('phone').value.trim();
      const countryCode = document.getElementById('countryCode').value.trim();
      const password = document.getElementById('password').value.trim();
      if(!phone || !password) { authMsg.innerText='Enter phone & password'; return; }

      const res = await fetch(API+'/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: countryCode+phone, password })
      });
      const data = await res.json();
      if(data.token){
        token = data.token;
        currentUser = data.phone;
        userPhoneSpan.innerText = currentUser;
        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
      } else {
        authMsg.innerText = data.error;
      }
    }

    // --- Sync contacts ---
    document.getElementById('syncContactsBtn').onclick = async () => {
      const raw = document.getElementById('contactsInput').value.trim();
      if(!raw) return;
      const contacts = raw.split(',').map(s=>s.trim());
      const res = await fetch(API+'/api/contacts/sync', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token },
        body: JSON.stringify({ contacts })
      });
      const data = await res.json();
      contactsList.innerHTML = '';
      chatWithSelect.innerHTML = '';
      data.registered.forEach(u=>{
        const div = document.createElement('div');
        div.innerText = u.username || u.phone;
        contactsList.appendChild(div);
        const opt = document.createElement('option');
        opt.value = u.phone;
        opt.innerText = u.username || u.phone;
        chatWithSelect.appendChild(opt);
      });
    }

    // --- Send message ---
    document.getElementById('sendBtn').onclick = async () => {
      const receiver = chatWithSelect.value;
      const text = document.getElementById('messageInput').value.trim();
      if(!receiver || !text) return;
      const res = await fetch(API+'/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token },
        body: JSON.stringify({ sender: currentUser, receiver, text })
      });
      const data = await res.json();
      loadMessages(receiver);
      document.getElementById('messageInput').value = '';
    }

    // --- Load messages ---
    async function loadMessages(other){
      if(!other) return;
      const res = await fetch(API+'/api/messages/'+currentUser+'/'+encodeURIComponent(other), {
        headers: { 'Authorization': 'Bearer '+token }
      });
      const data = await res.json();
      messagesDiv.innerHTML = '';
      data.forEach(m=>{
        const div = document.createElement('div');
        div.className = 'message '+(m.sender===currentUser?'self':'other');
        div.innerText = (m.sender===currentUser?'You: ':'') + m.text;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    chatWithSelect.onchange = () => loadMessages(chatWithSelect.value);

    // --- Status feed ---
    document.getElementById('postStatusBtn').onclick = async () => {
      const text = document.getElementById('statusInput').value.trim();
      if(!text) return;
      await fetch(API+'/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token },
        body: JSON.stringify({ text })
      });
      loadStatusFeed();
      document.getElementById('statusInput').value = '';
    }

    async function loadStatusFeed(){
      const res = await fetch(API+'/status/feed', { headers: { 'Authorization': 'Bearer '+token } });
      const data = await res.json();
      statusFeedDiv.innerHTML = '';
      data.forEach(s=>{
        const div = document.createElement('div');
        div.innerText = `${s.user}: ${s.text}`;
        statusFeedDiv.appendChild(div);
      });
    }

  </script>
</body>
</html>
